<body class="p-4 bg-light">
  <div class="container text-center mt-5">
    <h2 class="mb-4">Confirm Payment</h2>
    <div class="card p-4 mx-auto" style="max-width: 400px;">
      <img src="<%= product.image %>" class="img-fluid mb-3 rounded" alt="<%= product.name %>">
      <h4>
        <%= product.name %>
      </h4>
      <p><strong>Price:</strong> ₹<%= product.price %>
      </p>
      <p><strong>Quantity:</strong>
        <%= quantity %>
      </p>
      <p><strong>Total:</strong> ₹<%= totalAmount %>
      </p>
      <button id="payBtn" class="userDash-btn-order">Pay Now</button> <br>
      <button id="codBtn" class="userDash-btn-order" style="border: 2px solid black;">Cash On Delivery</button>
    </div>

    <div id="payment-status" class="mt-4"></div>
  </div>

  <script>
    document.getElementById("codBtn").addEventListener("click", async function () {
      Swal.fire({
        title: "Confirm Cash on Delivery?",
        text: "Are you sure you want to place this order as Cash on Delivery?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Yes, Confirm",
        cancelButtonText: "Cancel",
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
      }).then(async (result) => {
        if (result.isConfirmed) {
          const resp = await fetch("/user/codOrder", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              productId: "<%= product._id %>",
              quantity: <%= quantity %>,
              totalAmount : <%= totalAmount %>
        }),
        });

      const resultData = await resp.json();
      const statusDiv = document.getElementById("payment-status");

      if (resultData.success) {
        Swal.fire({
          icon: "success",
          title: "Order Placed!",
          text: "Your Cash on Delivery order was successful.",
          timer: 2000,
          showConfirmButton: false,
        });
        setTimeout(() => window.location.href = "/user/dashboard", 2000);
      } else {
        Swal.fire({
          icon: "error",
          title: "Failed!",
          text: "Something went wrong. Please try again.",
        });
      }
    }
  });
});


    document.getElementById("payBtn").addEventListener("click", function () {
      const options = {
        key: "<%= key %>",
        amount: <%= totalAmount * 100 %>,
        currency: "INR",
        name: "Artisan Store",
        description: "Product Payment",
        order_id: "<%= orderId %>",
        handler: async function (response) {
          const verifyResp = await fetch("/user/verifyPayment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ...response,
              productId: "<%= product._id %>",
              quantity: <%= quantity %>,
              totalAmount: <%= totalAmount %>,
            }),
        });
    const result = await verifyResp.json();
    const statusDiv = document.getElementById("payment-status");

    if (result.success) {
      statusDiv.innerHTML = `<div class='alert alert-success'> Payment successful! Redirecting...</div>`;
      setTimeout(() => window.location.href = "/user/dashboard", 2000);
    } else {
      statusDiv.innerHTML = `<div class='alert alert-danger'> Payment verification failed. Please try again.</div>`;
    }
        },
    theme: {
      color: "#3399cc"
    }
      };
    const rzp = new Razorpay(options);
    rzp.on('payment.failed', function (response) {
      document.getElementById("payment-status").innerHTML =
        `<div class='alert alert-danger'> Payment Failed! Reason: ${response.error.description}</div>`;
    });
    rzp.open();
    });
  </script>
</body>